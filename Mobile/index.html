<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Odysseus Chat - Mobile</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Highlight.js Theme (Atom One Dark) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />
    <!-- Marked.js for Markdown parsing (Pinned Version) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script>
    <!-- Highlight.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="app-container">
      <!-- Model Loading Overlay -->
      <div
        id="model-loading-overlay"
        style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.9);
          z-index: 9999;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          color: white;
        "
      >
        <h1 style="text-align: center; font-size: 200%" class="logo">Odysseus Mobile</h1>
        <p id="model-loading-text">Starting...</p>
        <div
          style="
            width: 80%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
          "
        >
          <div
            id="model-loading-bar"
            style="width: 0%; height: 100%; background: #00ff00; transition: width 0.3s"
          ></div>
        </div>
        <button
          id="btn-start-engine"
          style="
            margin-top: 20px;
            padding: 10px 20px;
            background: #00ff00;
            color: black;
            border: none;
            height: 5vh;
            border-radius: 5px;
            cursor: pointer;
            font-size: medium;
            font-weight: bold;
          "
        >
          Download or Load Model
        </button>
      </div>

      <!-- Context Menu (Hidden) -->
      <div id="context-menu" class="context-menu">
        <div class="context-item" id="ctx-rename"><i class="fas fa-pen"></i> Rename</div>
        <div class="context-item" id="ctx-delete" style="color: #ff5555">
          <i class="fas fa-trash"></i> Delete
        </div>
      </div>

      <!-- LEFT SIDEBAR -->
      <aside class="sidebar-left">
        <div class="sidebar-header" style="position: relative; padding-left: 20px">
          <div class="logo">ODYSSEUS MOBILE</div>
        </div>

        <div class="session-list-container">
          <div
            class="section-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-right: 10px;
            "
          >
            <span>Sessions</span>
            <i
              class="fas fa-plus"
              id="btn-new-session"
              style="cursor: pointer; color: #0f0"
              title="New Session"
            ></i>
          </div>
          <div id="session-list">
            <!-- Dynamic Sessions will be loaded here -->
          </div>
          <div style="padding: 10px; text-align: center">
            <input type="file" id="import-session-file" accept=".json" style="display: none" />
            <button
              id="btn-import-session"
              style="
                background: none;
                border: 1px solid #444;
                color: #888;
                cursor: pointer;
                padding: 5px 10px;
                width: 100%;
                font-size: 0.8rem;
              "
            >
              <i class="fas fa-file-import"></i> Import Chat from Disk
            </button>
          </div>
        </div>

        <div class="model-list-container">
          <div
            class="section-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-right: 10px;
            "
          >
            <span>Saved Models</span>
            <i
              class="fas fa-plus"
              id="btn-add-model-def"
              style="cursor: pointer; color: #0f0"
              title="Add Model Definition"
            ></i>
          </div>
          <div class="model-list">
            <!-- Dynamic Models -->
          </div>
        </div>
      </aside>

      <!-- MAIN CHAT AREA -->
      <main class="chat-area">
        <header class="chat-header">
          <button id="btn-toggle-left" class="mobile-toggle"><i class="fas fa-bars"></i></button>
          <div class="header-title">Session: THE SWARM</div>
          <div class="header-actions">
            <button id="btn-toggle-right" class="mobile-toggle">
              <i class="fas fa-chart-bar"></i>
            </button>
          </div>
        </header>

        <div class="messages-container" id="messages">
          <!-- Messages will be injected here by script.js -->
          <div class="system-message">System ready. WebLLM Engine initialized.</div>
        </div>

        <div class="input-area">
          <div class="input-wrapper">
            <div class="input-row" style="display: flex; gap: 10px; align-items: center">
              <input
                type="text"
                id="question"
                placeholder="Send a message to the council..."
                autofocus
                style="flex: 1"
              />
              <button
                id="btn-submit"
                class="action-icon"
                title="Send Message"
                style="font-size: 1.2rem; padding: 8px"
              >
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            <div class="input-actions">
              <button class="action-btn" id="btn-mode-research">Research</button>
              <button class="action-btn" id="btn-mode-thinking" title="Force Thinking Process">
                Thinking
              </button>
            </div>
          </div>
        </div>
      </main>

      <!-- RIGHT SIDEBAR (Stats) -->
      <aside class="sidebar-right">
        <div class="stats-header">SYSTEM METRICS</div>

        <div class="stat-block">
          <div class="stat-row"><span>Total Requests</span> <span id="stat-requests">0</span></div>
          <div class="bar"><div class="fill" id="bar-requests" style="width: 0%"></div></div>
        </div>

        <div class="stat-block">
          <div class="stat-row"><span>Prompt Tokens</span> <span id="stat-prompt">0</span></div>
          <div class="bar"><div class="fill" id="bar-prompt" style="width: 0%"></div></div>
        </div>

        <div class="stat-block">
          <div class="stat-row">
            <span>Completion Tokens</span> <span id="stat-completion">0</span>
          </div>
          <div class="bar"><div class="fill" id="bar-completion" style="width: 0%"></div></div>
        </div>

        <div class="stat-block">
          <div class="stat-row"><span>Last Speed</span> <span id="stat-speed">0 T/s</span></div>
          <div class="bar"><div class="fill" id="bar-speed" style="width: 0%"></div></div>
        </div>

        <div class="process-list">
          <div class="section-title">Active Personalities</div>
          <div id="active-models-list">
            <!-- Will be filled by JS -->
          </div>
          <div
            class="add-model-container"
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #333;
              text-align: center;
            "
          >
            <button
              id="btn-open-add-modal"
              style="
                width: 100%;
                padding: 8px;
                background: #333;
                border: 1px solid #444;
                color: #fff;
                cursor: pointer;
                border-radius: 4px;
              "
            >
              <i class="fas fa-plus"></i> Add Member
            </button>
          </div>
        </div>
      </aside>
    </div>

    <!-- ADD PERSONA MODAL -->
    <div id="add-persona-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Council Member</h3>
          <span class="close-modal" id="btn-close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="new-persona-name" placeholder="e.g. SKEPTIC" />
          </div>
          <div class="form-group">
            <label>System Prompt (Character)</label>
            <textarea
              id="new-persona-prompt"
              rows="4"
              placeholder="Describe how this member should behave..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>Model ID (Optional)</label>
            <input
              type="text"
              id="new-persona-model-id"
              placeholder="e.g. gpt-4, qwen-2.5-7b-instruct, or leave empty for default"
            />
          </div>
          <div class="form-group">
            <label>Color</label>
            <div class="color-picker-wrapper">
              <input type="color" id="new-persona-color" value="#00ff00" />
              <input
                type="text"
                id="new-persona-color-text"
                value="#00ff00"
                maxlength="7"
                placeholder="#000000"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btn-cancel-persona">Cancel</button>
          <button id="btn-save-persona" class="primary">Save Member</button>
        </div>
      </div>
    </div>

    <!-- ADD MODEL DEFINITION MODAL -->
    <div id="add-model-def-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Saved Model</h3>
          <span class="close-modal" id="btn-close-model-def">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="new-model-def-name" placeholder="e.g. GPT-4 Turbo" />
          </div>
          <div class="form-group">
            <label>Model ID (API String)</label>
            <div style="display: flex; gap: 5px">
              <input
                type="text"
                id="new-model-def-id"
                placeholder="e.g. gpt-4-turbo-preview"
                style="flex: 1"
              />
              <button
                id="btn-fetch-loaded-id"
                title="Get ID from LM Studio"
                style="padding: 0 10px; cursor: pointer"
              >
                <i class="fas fa-sync"></i>
              </button>
            </div>
            <small style="color: #666; font-size: 0.8em"
              >Click icon to get ID of currently loaded model in LM Studio.</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button id="btn-cancel-model-def">Cancel</button>
          <button id="btn-save-model-def" class="primary">Save Model</button>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRMATION POPOVER -->
    <div id="delete-confirm-modal" class="delete-popover">
      <div class="delete-popover-content">
        <p id="delete-confirm-text">Remove this member?</p>
        <div class="delete-popover-actions">
          <button id="btn-cancel-delete" class="btn-cancel">Cancel</button>
          <button id="btn-confirm-delete" class="btn-confirm">Delete</button>
        </div>
      </div>
    </div>

    <script type="module" src="script.js"></script>
  </body>
</html>
